<div id="gameDiv" style="display:none;">
    <canvas id="ctx" width="640px" height="480px" style="border: 2px solid #1a1a1a; padding: 0; margin: auto; display: block;"></canvas>

    <div id="chat-text" style="width: 640px; height: 100px; overflow-y: scroll; padding: 0; margin: auto; display: block; flex-direction: column;">
        <div>Start chatting here!</div>
    </div>

    <form id="chat-form" autocomplete="off">
        <input id="chat-input" type="text" style="width: 640px; padding: 0; margin: auto; display: block;" autocomplete="off">
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js" integrity="sha512-WL6WGKMPBiM9PnHRYIn5YEtq0Z8XP4fkVb4qy7PP4vhmYQErJ/dySyXuFIMDf1eEYCXCrQrMJfkNwKc9gsjTjA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

<div id="loginDiv">
    <input id="connect" type="button" value="Connect Metamask" onclick="Connect()">
</div>

<script>
    // Metamask
    var web3, address;
    
    async function Connect() {
        await window.ethereum.enable();
        web3 = new Web3(window.ethereum);
        gameDiv = document.getElementById("gameDiv");
        loginDiv = document.getElementById("loginDiv");
        gameDiv.style.display = "block";
        loginDiv.style.display = "none";
        web3.eth.getAccounts().then(e => { 
            address = e[0];
            socket.emit("newAddress", address);
        });
    }
</script>

<script>
    // Client Input
    const WIDTH = 640;
    const HEIGHT = 480;
    var ID = 0

    var Sprite = {};
    Sprite.map = new Image();
    Sprite.map.src = "client/assets/sprites/grid.png";

    var chatText = document.getElementById("chat-text");
    var chatInput = document.getElementById("chat-input");
    var chatForm = document.getElementById("chat-form");

    var ctx = document.getElementById("ctx").getContext("2d");

    var socket = io();

    socket.on("newPosition", function(data){
        ctx.clearRect(0, 0, 640, 480);
        //drawMap();
        
        for (var i=0; i < data.length; i++) {
            ctx.beginPath();
            ctx.rect(data[i].x, data[i].y, data[i].size, data[i].size);
            ctx.fillStyle = "crimson";
            ctx.fill();
        }
    });

    socket.on("addToChat", function(data) {
        chatText.innerHTML += "<div>" + data + "</div>";
    });

    socket.on("newId", function(data) {
        ID = data;
    });

    chatForm.onsubmit = function(e) {
        e.preventDefault();
        socket.emit("sendMsgToServer", chatInput.value);
        chatInput.value = "";
    }

    var drawMap = function() {
        ctx.drawImage(Sprite.map, 0, 0);
    }

    document.onkeydown = function(event) {
        if (event.keyCode == 68) // D
            socket.emit("keyPress", {inputId: "right", state: true});
        if (event.keyCode == 65) // A
            socket.emit("keyPress", {inputId: "left", state: true});
        if (event.keyCode == 87) // W
            socket.emit("keyPress", {inputId: "up", state: true});
        if (event.keyCode == 83) // S
            socket.emit("keyPress", {inputId: "down", state: true});
    }
    document.onkeyup = function(event) {
        if (event.keyCode == 68) // D
            socket.emit("keyPress", {inputId: "right", state: false});
        if (event.keyCode == 65) // A
            socket.emit("keyPress", {inputId: "left", state: false});
        if (event.keyCode == 87) // W
            socket.emit("keyPress", {inputId: "up", state: false});
        if (event.keyCode == 83) // S
            socket.emit("keyPress", {inputId: "down", state: false});
    }
</script>